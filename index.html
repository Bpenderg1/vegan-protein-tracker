<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Vegan Protein Tracker</title>
    <style>
        :root {
            --primary: #4A9F46;
            --secondary: #2D6A2E;
            --light: #E8F5E4;
            --dark: #1E441F;
            --accent: #F7B32B;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            text-align: center;
            padding: 1rem;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        h1, h2, h3 {
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        button {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
        }
        
        button:hover {
            background-color: var(--secondary);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        
        .analyzed-items {
            margin: 15px 0;
            padding: 10px;
            background-color: var(--light);
            border-radius: 6px;
        }
        
        .analyzed-items ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        .ingredient-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-container {
            background-color: #ddd;
            border-radius: 20px;
            height: 20px;
            width: 100%;
            margin: 10px 0 20px 0;
        }
        
        .progress-bar {
            background-color: var(--primary);
            height: 20px;
            border-radius: 20px;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
            transition: width 0.3s ease-in-out;
        }
        
        .progress-bar.warning {
            background-color: #f39c12;
        }
        
        .progress-bar.danger {
            background-color: #e74c3c;
        }
        
        #meal-history {
            margin-top: 20px;
        }
        
        #meals-list {
            list-style: none;
            padding: 0;
        }
        
        .meal-item {
            background-color: var(--light);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--primary);
        }
        
        .meal-item h4 {
            margin: 0 0 5px 0;
            display: flex;
            justify-content: space-between;
        }
        
        .meal-item p {
            margin: 5px 0;
        }
        
        .meal-delete {
            color: #e74c3c;
            cursor: pointer;
            font-weight: bold;
        }
        
        .meal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .meal-buttons button {
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .meal-buttons .reuse-meal {
            background-color: var(--accent);
        }
        
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            display: none;
        }
        
        .just-eaten-checkbox {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .just-eaten-checkbox input {
            width: auto;
            margin-right: 10px;
            margin-bottom: 0;
        }
        
        .debug-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            background-color: rgba(0,0,0,0.8);
            color: #fff;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 6px;
            z-index: 1000;
        }
        
        .highlight {
            animation: highlight-animation 1s ease-in-out;
        }
        
        @keyframes highlight-animation {
            0% { background-color: var(--accent); }
            100% { background-color: transparent; }
        }
        
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .button-row button {
            flex: 1;
        }
        
        .reset-button {
            background-color: #888;
        }
        
        .manual-entry {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 6px;
        }
        
        .manual-entry h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        
        .manual-entry-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .manual-entry-row input {
            margin-bottom: 0;
        }
        
        .manual-entry-row button {
            padding: 5px 10px;
            margin: 0;
        }
        
        @media (max-width: 576px) {
            .container {
                padding: 10px;
            }
            
            .ingredient-item {
                flex-direction: column;
            }
            
            .manual-entry-row {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        #debug-info {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <header>
        <h1>Simple Vegan Protein Tracker</h1>
    </header>
    
    <div class="container">
        <div class="card">
            <h2>Protein Calculator</h2>
            <p>Enter your weight to calculate your recommended protein intake:</p>
            <div>
                <label for="weight">Weight (kg):</label>
                <input type="number" id="weight" placeholder="Enter weight in kg">
            </div>
            <div>
                <label for="activity">Activity Level:</label>
                <select id="activity">
                    <option value="1.0">Light Activity</option>
                    <option value="1.1" selected>Moderate Activity</option>
                    <option value="1.2">Heavy Activity</option>
                    <option value="1.4">Athlete</option>
                </select>
            </div>
            <div>
                <button onclick="calculateProtein()">Calculate</button>
            </div>
            <div id="results" style="margin-top: 15px; display: none;">
                <p>Your daily protein goal: <span id="daily-goal">0</span>g</p>
                <p>Weekly goal: <span id="weekly-goal">0</span>g</p>
            </div>
        </div>
        
        <div class="card">
            <h2>Analyze Meal Protein</h2>
            <p>Describe your meal and we'll estimate the protein content:</p>
            <div>
                <label for="meal-name">Meal Name:</label>
                <input type="text" id="meal-name" placeholder="Breakfast, Lunch, Dinner, Snack, etc.">
            </div>
            <div>
                <label for="meal-date">Date:</label>
                <input type="date" id="meal-date">
            </div>
            <textarea id="meal-description" rows="4" placeholder="E.g., 1 cup tofu, 1/2 cup chickpeas, 2 tbsp flax seeds"></textarea>
            <button onclick="analyzeProtein()">Analyze Protein</button>
            
            <div class="manual-entry">
                <h4>Manual Food Entry</h4>
                <p>Can't find a food? Add it manually:</p>
                <div class="manual-entry-row">
                    <input type="text" id="manual-food-name" placeholder="Food name (e.g., Lentil Soup)">
                    <input type="number" id="manual-food-protein" placeholder="Protein (g)">
                    <button onclick="addManualFood()">Add Food</button>
                </div>
            </div>
            
            <div id="analyzed-items" class="analyzed-items" style="display: none;">
                <h3>Identified Ingredients:</h3>
                <ul id="ingredient-list"></ul>
                <p>Estimated total protein: <span id="estimated-protein">0</span>g</p>
                <div class="just-eaten-checkbox">
                    <input type="checkbox" id="just-eaten" checked>
                    <label for="just-eaten">I just ate this (count toward today's protein)</label>
                </div>
                <div class="button-row">
                    <button onclick="saveMeal()">Save Meal</button>
                    <button onclick="resetMealForm()" class="reset-button">Reset</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Protein Tracking</h2>
            <div id="tracking-summary">
                <h3>Today's Progress</h3>
                <p>Daily Goal: <span id="tracking-daily-goal">0</span>g</p>
                <p>Consumed Today: <span id="consumed-today">0</span>g</p>
                <div class="progress-container">
                    <div id="daily-progress" class="progress-bar" style="width: 0%;">0%</div>
                </div>
                
                <h3>Weekly Progress</h3>
                <p>Weekly Goal: <span id="tracking-weekly-goal">0</span>g</p>
                <p>Consumed This Week: <span id="consumed-week">0</span>g</p>
                <div class="progress-container">
                    <div id="weekly-progress" class="progress-bar" style="width: 0%;">0%</div>
                </div>
            </div>
            
            <h3>Saved Meals</h3>
            <div id="meal-history">
                <p id="no-meals" style="display: block;">No saved meals yet.</p>
                <ul id="meals-list"></ul>
            </div>
            <button onclick="clearMeals()" style="background-color: #e74c3c;">Clear All Meals</button>
        </div>
    </div>
    
    <div id="toast" class="toast"></div>
    <div id="debug-output" class="debug-panel" style="display: none;"></div>
    
    <script>
        // Vegan food database with protein content per 100g
        const veganFoods = [
            { name: "Tofu", protein: 10, synonyms: ["firm tofu", "silken tofu", "extra firm tofu", "soft tofu"] }, // Adjusted from 15g to 10g
            { name: "Tempeh", protein: 19 },
            { name: "Seitan", protein: 75, synonyms: ["wheat gluten", "vital wheat gluten"] }, // Adjusted from 25g to 75g
            { name: "Lentils", protein: 9, synonyms: ["red lentils", "green lentils", "brown lentils"] },
            { name: "Chickpeas", protein: 8.9, synonyms: ["garbanzo", "garbanzo beans"] },
            { name: "Black beans", protein: 8.7 },
            { name: "Kidney beans", protein: 8.7 }, // Added
            { name: "Pinto beans", protein: 8.2 }, // Added
            { name: "Edamame", protein: 11, synonyms: ["soybeans", "green soybeans"] },
            { name: "Quinoa", protein: 4.4 },
            { name: "Peanut butter", protein: 24, synonyms: ["pb"] },
            { name: "Almonds", protein: 21 },
            { name: "Almond butter", protein: 21 },
            { name: "Walnuts", protein: 15 }, // Added
            { name: "Nutritional yeast", protein: 45, synonyms: ["nooch"] },
            { name: "Soy milk", protein: 3.3, synonyms: ["soymilk", "soya milk"] },
            { name: "Hemp milk", protein: 1, synonyms: ["hemp beverage"] }, // Adjusted from 1.8g to 1g
            { name: "Almond milk", protein: 0.5, synonyms: ["almond beverage"] }, // Added
            { name: "Oat milk", protein: 0.7, synonyms: ["oat beverage"] }, // Added
            { name: "Hemp seeds", protein: 31, synonyms: ["hemp hearts"] },
            { name: "Chia seeds", protein: 17 },
            { name: "Pumpkin seeds", protein: 30, synonyms: ["pepitas"] },
            { name: "Spirulina", protein: 57, synonyms: ["blue-green algae"] },
            { name: "Oats", protein: 13, synonyms: ["rolled oats", "old-fashioned oats", "steel cut oats"] },
            { name: "Pea protein", protein: 80 },
            { name: "Broccoli", protein: 2.8, synonyms: ["brocolli", "brocoli"] },
            { name: "Spinach", protein: 2.9 },
            { name: "Kale", protein: 3.3 }, // Added
            { name: "Protein pasta", protein: 25 },
            { name: "Beyond Burger", protein: 20 },
            { name: "Impossible Burger", protein: 19 },
            { name: "Protein shake", protein: 20 },
            { name: "Soy yogurt", protein: 4 },
            { name: "Coconut yogurt", protein: 1.5 },
            { name: "Flax seeds", protein: 18, synonyms: ["flaxseeds", "flaxseed", "flax"] },
            { name: "Wheat germ", protein: 23 },
            { name: "Moringa powder", protein: 25, synonyms: ["moringa", "moringa leaf"] },
            { name: "Psyllium husk", protein: 0.5, synonyms: ["psylium husk", "psyllium powder", "psylium powder"] },
            { name: "Cacao powder", protein: 20, synonyms: ["cocao powder", "cocoa powder", "cacao", "cocao", "cocoa"] },
            { name: "Collard greens", protein: 2.5 },
            { name: "Parsley", protein: 2.2 },
            { name: "Banana", protein: 1.1 },
            { name: "Apple", protein: 0.3 },
            { name: "Blueberries", protein: 0.7 },
            { name: "Strawberries", protein: 0.7 },
            // Common prepared foods with protein content per serving
            { name: "Lentil soup", protein: 10, servingSize: "1 bowl (200ml)" }, // Adjusted
            { name: "Vegetable soup", protein: 4, servingSize: "1 bowl (200ml)" }, // Adjusted from 5g to 4g
            { name: "Split pea soup", protein: 10, servingSize: "1 bowl (200ml)" },
            { name: "Bean soup", protein: 8, servingSize: "1 bowl (200ml)" },
            { name: "Hummus", protein: 4, servingSize: "1/4 cup" }, // Adjusted from 8g to 4g
            { name: "Falafel", protein: 3, servingSize: "1 piece" }, // Adjusted from 7g to 3g
            { name: "Tofu scramble", protein: 12, servingSize: "1 cup" }, // Adjusted from 14g to 12g
            { name: "Veggie burger", protein: 12, servingSize: "1 patty" }, // Adjusted from 15g to 12g
            { name: "Bread", protein: 4, servingSize: "1 slice", synonyms: ["whole grain bread", "sourdough", "wheat bread"] },
            { name: "Bagel", protein: 9, servingSize: "1 bagel" },
            { name: "Granola", protein: 6, servingSize: "1/2 cup" },
            { name: "Vegan yogurt", protein: 4, servingSize: "1 cup" }, // Adjusted from 5g to 4g
            { name: "Salad", protein: 2, servingSize: "1 bowl", synonyms: ["garden salad", "green salad"] }, // Adjusted from 3g to 2g
            { name: "Stir fry", protein: 10, servingSize: "1 cup" }, // Adjusted from 12g to 10g
            { name: "Pasta with tomato sauce", protein: 7, servingSize: "1 cup" }  // Adjusted from 8g to 7g
        ];
        
        // Reference measures for descriptive text parsing
        const measurementReferences = [
            { terms: ["cup", "cups", "c."], grams: 240 }, // Fixed: 1 cup = 16 tbsp = 240g
            { terms: ["tbsp", "tbs", "tablespoon", "tablespoons", "tb", "tbl"], grams: 15 },
            { terms: ["tsp", "teaspoon", "teaspoons", "ts", "t"], grams: 5 },
            { terms: ["gram", "grams", "g"], grams: 1 },
            { terms: ["ounce", "ounces", "oz"], grams: 28 },
            { terms: ["pound", "pounds", "lb", "lbs"], grams: 454 },
            { terms: ["handful", "hand"], grams: 30 },
            { terms: ["slice", "slices"], grams: 20 },
            { terms: ["stalk", "stalks"], grams: 40 },
            { terms: ["floret", "florets"], grams: 10 },
            { terms: ["bowl", "bowls"], grams: 250 },
            { terms: ["piece", "pieces"], grams: 30 },
            { terms: ["patty", "patties"], grams: 100 }
        ];
        
        // In-memory storage as fallback for localStorage
        const memoryStorage = {
            goals: {
                daily: 0,
                weekly: 0,
                weight: 0,
                activity: 1.1
            },
            meals: []
        };
        
        // Global variables to store analyzed meal
        let currentMealProtein = 0;
        let currentMealItems = [];
        
        // Helper function to show toast messages
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.display = 'block';
            
            setTimeout(function() {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // Debug helper
        function debug(message) {
            console.log(message);
            
            const debugPanel = document.getElementById('debug-output');
            const p = document.createElement('p');
            p.textContent = message;
            debugPanel.appendChild(p);
            debugPanel.style.display = 'block';
            
            // Auto-scroll to bottom
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        // Safe localStorage wrapper
        function safeStorage() {
            const testKey = '__test__';
            try {
                localStorage.setItem(testKey, testKey);
                localStorage.removeItem(testKey);
                debug("localStorage is available!");
                return {
                    get: function(key) {
                        try {
                            return localStorage.getItem(key);
                        } catch (e) {
                            debug(`Error getting ${key} from localStorage: ${e.message}`);
                            return null;
                        }
                    },
                    set: function(key, value) {
                        try {
                            localStorage.setItem(key, value);
                            return true;
                        } catch (e) {
                            debug(`Error setting ${key} in localStorage: ${e.message}`);
                            return false;
                        }
                    },
                    remove: function(key) {
                        try {
                            localStorage.removeItem(key);
                            return true;
                        } catch (e) {
                            debug(`Error removing ${key} from localStorage: ${e.message}`);
                            return false;
                        }
                    }
                };
            } catch (e) {
                debug("localStorage is NOT available! Using memory storage fallback.");
                return {
                    get: function(key) {
                        if (key === 'protein-goals') {
                            return JSON.stringify(memoryStorage.goals);
                        } else if (key === 'protein-meals') {
                            return JSON.stringify(memoryStorage.meals);
                        }
                        return null;
                    },
                    set: function(key, value) {
                        if (key === 'protein-goals') {
                            memoryStorage.goals = JSON.parse(value);
                        } else if (key === 'protein-meals') {
                            memoryStorage.meals = JSON.parse(value);
                        }
                        return true;
                    },
                    remove: function(key) {
                        if (key === 'protein-goals') {
                            memoryStorage.goals = {
                                daily: 0,
                                weekly: 0,
                                weight: 0,
                                activity: 1.1
                            };
                        } else if (key === 'protein-meals') {
                            memoryStorage.meals = [];
                        }
                        return true;
                    }
                };
            }
        }
        
        // Initialize storage helper
        const storage = safeStorage();
        
        // Reset meal form
        function resetMealForm() {
            debug("Resetting meal form");
            document.getElementById('meal-name').value = '';
            document.getElementById('meal-description').value = '';
            document.getElementById('analyzed-items').style.display = 'none';
            currentMealProtein = 0;
            currentMealItems = [];
            
            // Remove debug info if it exists
            const debugInfo = document.getElementById('debug-info');
            if (debugInfo) {
                debugInfo.remove();
            }
            
            showToast('Form reset');
        }
        
        // Function to get current date in YYYY-MM-DD format
        function getCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Add a food manually
        function addManualFood() {
            const foodName = document.getElementById('manual-food-name').value.trim();
            const proteinAmount = parseFloat(document.getElementById('manual-food-protein').value);
            
            if (!foodName) {
                showToast('Please enter a food name');
                return;
            }
            
            if (isNaN(proteinAmount) || proteinAmount < 0) {
                showToast('Please enter a valid protein amount');
                return;
            }
            
            debug(`Adding manual food: ${foodName} with ${proteinAmount}g protein`);
            
            // Create an item for the manually added food
            const manualItem = {
                food: foodName,
                serving: "1 serving (custom)",
                protein: proteinAmount,
                originalText: `${foodName} (manually added)`
            };
            
            // Update globals
            currentMealItems.push(manualItem);
            currentMealProtein += proteinAmount;
            
            // Update display
            updateAnalysisDisplay();
            
            // Clear manual entry form
            document.getElementById('manual-food-name').value = '';
            document.getElementById('manual-food-protein').value = '';
            
            showToast(`Added ${foodName} with ${proteinAmount}g protein`);
        }
        
        // Update analysis display with current items
        function updateAnalysisDisplay() {
            const ingredientList = document.getElementById('ingredient-list');
            ingredientList.innerHTML = '';
            
            if (currentMealItems.length === 0) {
                document.getElementById('analyzed-items').style.display = 'none';
                return;
            }
            
            for (let i = 0; i < currentMealItems.length; i++) {
                const item = currentMealItems[i];
                const li = document.createElement('li');
                li.className = 'ingredient-item';
                li.innerHTML = `
                    <div><strong>${item.food}</strong> (${item.serving})</div>
                    <div>${item.protein}g protein</div>
                    <div style="font-size: 0.8em; color: #666; overflow: hidden; text-overflow: ellipsis; max-width: 100%;">"${item.originalText}"</div>
                `;
                ingredientList.appendChild(li);
            }
            
            document.getElementById('estimated-protein').textContent = currentMealProtein.toFixed(1);
            document.getElementById('analyzed-items').style.display = 'block';
        }
        
        // Set today's date as default for the meal date input
        window.onload = function() {
            // Enable debug mode
            debug("App started. Initializing...");
            
            const todayStr = getCurrentDate();
            document.getElementById('meal-date').value = todayStr;
            debug(`Set default date: ${todayStr}`);
            
            // Load saved data
            loadSavedData();
        };
        
        // Calculate protein based on weight and activity level
        function calculateProtein() {
            const weight = parseFloat(document.getElementById('weight').value);
            const activity = parseFloat(document.getElementById('activity').value);
            
            if (isNaN(weight) || weight <= 0) {
                showToast('Please enter a valid weight');
                debug(`Invalid weight: ${weight}`);
                return;
            }
            
            const dailyProtein = Math.round(weight * activity);
            const weeklyProtein = dailyProtein * 7;
            
            debug(`Calculated goals: ${dailyProtein}g daily, ${weeklyProtein}g weekly`);
            
            document.getElementById('daily-goal').textContent = dailyProtein;
            document.getElementById('weekly-goal').textContent = weeklyProtein;
            document.getElementById('results').style.display = 'block';
            
            // Update tracking section
            document.getElementById('tracking-daily-goal').textContent = dailyProtein;
            document.getElementById('tracking-weekly-goal').textContent = weeklyProtein;
            
            // Save goals
            const goals = {
                daily: dailyProtein,
                weekly: weeklyProtein,
                weight: weight,
                activity: activity
            };
            
            storage.set('protein-goals', JSON.stringify(goals));
            debug("Goals saved to storage");
            
            updateProgressBars();
            showToast('Protein goals calculated and saved!');
        }
        
        // Load saved data (goals and meals)
        function loadSavedData() {
            // Load goals
            const savedGoals = storage.get('protein-goals');
            if (savedGoals) {
                try {
                    const goals = JSON.parse(savedGoals);
                    debug(`Loaded goals: ${goals.daily}g daily, ${goals.weekly}g weekly`);
                    
                    document.getElementById('weight').value = goals.weight || '';
                    document.getElementById('activity').value = goals.activity || '1.1';
                    
                    if (goals.daily && goals.weekly) {
                        document.getElementById('daily-goal').textContent = goals.daily;
                        document.getElementById('weekly-goal').textContent = goals.weekly;
                        document.getElementById('results').style.display = 'block';
                        
                        document.getElementById('tracking-daily-goal').textContent = goals.daily;
                        document.getElementById('tracking-weekly-goal').textContent = goals.weekly;
                    }
                } catch (e) {
                    debug(`Error parsing saved goals: ${e.message}`);
                }
            } else {
                debug("No saved goals found");
            }
            
            // Load meals
            loadMeals();
            updateProgressBars();
        }
        
        // Save a meal
        function saveMeal() {
            if (currentMealProtein <= 0 || currentMealItems.length === 0) {
                showToast('Please analyze a meal first');
                debug("Attempted to save meal without analysis");
                return;
            }
            
            const mealName = document.getElementById('meal-name').value.trim() || 'Untitled Meal';
            const mealDate = document.getElementById('meal-date').value;
            
            if (!mealDate) {
                showToast('Please select a date for the meal');
                debug("Attempted to save meal without date");
                return;
            }
            
            // Create meal object
            const meal = {
                id: Date.now(), // unique ID based on timestamp
                name: mealName,
                date: mealDate,
                protein: parseFloat(currentMealProtein),
                items: currentMealItems,
                description: document.getElementById('meal-description').value.trim()
            };
            
            debug(`Creating new meal: ${mealName}, ${meal.protein}g protein, date: ${mealDate}`);
            
            // Get saved meals or initialize empty array
            let meals = [];
            const savedMeals = storage.get('protein-meals');
            if (savedMeals) {
                try {
                    meals = JSON.parse(savedMeals);
                    debug(`Loaded ${meals.length} existing meals`);
                } catch (e) {
                    debug(`Error parsing saved meals: ${e.message}`);
                }
            } else {
                debug("No existing meals found");
            }
            
            // Add new meal
            meals.push(meal);
            debug(`Added meal to array. New total: ${meals.length} meals`);
            
            // Save back to storage
            const saveSuccess = storage.set('protein-meals', JSON.stringify(meals));
            debug(`Save to storage ${saveSuccess ? 'successful' : 'failed'}`);
            
            // Update UI immediately with direct meal data (bypass storage)
            updateUIWithNewMeal(meal, false); // Don't update progress if "just eaten" is not checked
            
            // Reset meal form
            resetMealForm();
            
            showToast('Meal saved successfully!');
        }
        
        // Update UI directly with new meal data (bypassing storage)
        function updateUIWithNewMeal(meal, updateProgress = true) {
            debug("Updating UI with new meal data directly");
            
            // Update meal list
            const mealsList = document.getElementById('meals-list');
            const noMealsMsg = document.getElementById('no-meals');
            
            // Hide the "no meals" message
            noMealsMsg.style.display = 'none';
            
            // Create a new list item for the meal
            const li = document.createElement('li');
            li.className = 'meal-item';
            
            li.innerHTML = `
                <h4>
                    ${meal.name}
                    <span class="meal-delete" onclick="deleteMeal(${meal.id})">&times;</span>
                </h4>
                <p><strong>Date:</strong> ${formatDate(meal.date)}</p>
                <p><strong>Protein:</strong> ${meal.protein.toFixed(1)}g</p>
                <p><small>${meal.items ? meal.items.length : 0} ingredients</small></p>
                <div class="meal-buttons">
                    <button class="reuse-meal" onclick="reuseMeal(${meal.id})">Use this meal</button>
                </div>
            `;
            
            // Add to the beginning of the list
            if (mealsList.firstChild) {
                mealsList.insertBefore(li, mealsList.firstChild);
            } else {
                mealsList.appendChild(li);
            }
            
            // Only update progress bars if updateProgress is true
            if (updateProgress) {
                updateProgressWithMeal(meal);
            }
        }
        
        // Update progress bars with a new meal
        function updateProgressWithMeal(meal) {
            debug("Updating progress with meal");
            
            // Get today's date for comparison
            const todayStr = getCurrentDate();
            debug(`Today's date: ${todayStr}, Meal date: ${meal.date}`);
            
            // Check if the meal is from today
            if (meal.date === todayStr) {
                debug(`Meal is from today! Adding ${meal.protein}g to today's total`);
                
                // Update today's consumed
                const consumedTodayElement = document.getElementById('consumed-today');
                const currentConsumed = parseFloat(consumedTodayElement.textContent) || 0;
                const newTotal = currentConsumed + parseFloat(meal.protein);
                
                debug(`Updating consumed today from ${currentConsumed}g to ${newTotal}g`);
                
                consumedTodayElement.textContent = newTotal.toFixed(1);
                consumedTodayElement.classList.add('highlight');
                
                // Update progress bar
                const dailyGoal = parseFloat(document.getElementById('tracking-daily-goal').textContent) || 0;
                if (dailyGoal > 0) {
                    const percentage = Math.min(Math.round((newTotal / dailyGoal) * 100), 100);
                    const progressBar = document.getElementById('daily-progress');
                    
                    progressBar.style.width = `${percentage}%`;
                    progressBar.textContent = `${percentage}%`;
                    
                    // Update class
                    progressBar.className = 'progress-bar';
                    if (percentage < 40) {
                        progressBar.classList.add('danger');
                    } else if (percentage < 70) {
                        progressBar.classList.add('warning');
                    }
                    
                    debug(`Updated daily progress to ${percentage}%`);
                }
            }
            
            // Get start of week date for comparison
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay()); // Go back to Sunday
            const startOfWeekStr = startOfWeek.toISOString().split('T')[0];
            
            // Check if meal is from this week
            if (meal.date >= startOfWeekStr) {
                // Update weekly consumed
                const consumedWeekElement = document.getElementById('consumed-week');
                const currentWeekConsumed = parseFloat(consumedWeekElement.textContent) || 0;
                const newWeekTotal = currentWeekConsumed + parseFloat(meal.protein);
                
                debug(`Updating consumed this week to ${newWeekTotal}g`);
                
                consumedWeekElement.textContent = newWeekTotal.toFixed(1);
                consumedWeekElement.classList.add('highlight');
                
                // Update weekly progress
                const weeklyGoal = parseFloat(document.getElementById('tracking-weekly-goal').textContent) || 0;
                if (weeklyGoal > 0) {
                    const weekPercentage = Math.min(Math.round((newWeekTotal / weeklyGoal) * 100), 100);
                    const weekProgressBar = document.getElementById('weekly-progress');
                    
                    weekProgressBar.style.width = `${weekPercentage}%`;
                    weekProgressBar.textContent = `${weekPercentage}%`;
                    
                    // Update class
                    weekProgressBar.className = 'progress-bar';
                    if (weekPercentage < 40) {
                        weekProgressBar.classList.add('danger');
                    } else if (weekPercentage < 70) {
                        weekProgressBar.classList.add('warning');
                    }
                    
                    debug(`Updated weekly progress to ${weekPercentage}%`);
                }
            }
        }
        
        // Reuse a saved meal
        function reuseMeal(mealId) {
            debug(`Reusing meal with ID: ${mealId}`);
            
            // First reset the current form
            resetMealForm();
            
            // Get saved meals
            const savedMeals = storage.get('protein-meals');
            if (!savedMeals) {
                debug("No saved meals found");
                return;
            }
            
            try {
                const meals = JSON.parse(savedMeals);
                const meal = meals.find(m => m.id === mealId);
                
                if (!meal) {
                    debug(`Meal with ID ${mealId} not found`);
                    return;
                }
                
                debug(`Found meal: ${meal.name}, ${meal.description}`);
                
                // Fill in the form with the saved meal data
                document.getElementById('meal-name').value = meal.name;
                document.getElementById('meal-description').value = meal.description;
                
                // Set today's date
                document.getElementById('meal-date').value = getCurrentDate();
                
                // Set global variables directly instead of re-analyzing
                currentMealItems = [...meal.items]; // Clone to avoid reference issues
                currentMealProtein = parseFloat(meal.protein);
                
                // Update display
                updateAnalysisDisplay();
                
                showToast(`Loaded "${meal.name}" for re-use`);
                
            } catch (e) {
                debug(`Error reusing meal: ${e.message}`);
            }
        }
        
        // Load and display saved meals
        function loadMeals() {
            const mealsList = document.getElementById('meals-list');
            const noMealsMsg = document.getElementById('no-meals');
            
            // Clear current list
            mealsList.innerHTML = '';
            
            // Get saved meals
            const savedMeals = storage.get('protein-meals');
            debug("Loading meals from storage");
            
            if (!savedMeals) {
                debug("No saved meals found in storage");
                noMealsMsg.style.display = 'block';
                return;
            }
            
            let meals = [];
            try {
                meals = JSON.parse(savedMeals);
                debug(`Found ${meals.length} saved meals in storage`);
            } catch (e) {
                debug(`Error parsing saved meals: ${e.message}`);
                noMealsMsg.style.display = 'block';
                return;
            }
            
            if (!meals || meals.length === 0) {
                debug("Meals array is empty");
                noMealsMsg.style.display = 'block';
                return;
            }
            
            noMealsMsg.style.display = 'none';
            
            // Sort meals by date (newest first)
            meals.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Add meals to list
            meals.forEach(meal => {
                debug(`Adding meal to list: ${meal.name}, ${meal.protein}g protein`);
                
                const li = document.createElement('li');
                li.className = 'meal-item';
                
                // Ensure protein value is valid
                const proteinValue = parseFloat(meal.protein) || 0;
                const itemsLength = meal.items ? meal.items.length : 0;
                
                li.innerHTML = `
                    <h4>
                        ${meal.name}
                        <span class="meal-delete" onclick="deleteMeal(${meal.id})">&times;</span>
                    </h4>
                    <p><strong>Date:</strong> ${formatDate(meal.date)}</p>
                    <p><strong>Protein:</strong> ${proteinValue.toFixed(1)}g</p>
                    <p><small>${itemsLength} ingredients</small></p>
                    <div class="meal-buttons">
                        <button class="reuse-meal" onclick="reuseMeal(${meal.id})">Use this meal</button>
                    </div>
                `;
                mealsList.appendChild(li);
            });
        }
        
        // Format date for display
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Delete a meal
        function deleteMeal(id) {
            if (confirm('Are you sure you want to delete this meal?')) {
                debug(`Deleting meal with ID: ${id}`);
                
                const savedMeals = storage.get('protein-meals');
                if (savedMeals) {
                    try {
                        let meals = JSON.parse(savedMeals);
                        const originalCount = meals.length;
                        meals = meals.filter(meal => meal.id !== id);
                        debug(`Filtered meals: removed ${originalCount - meals.length} meal(s)`);
                        
                        storage.set('protein-meals', JSON.stringify(meals));
                        
                        // Update UI
                        loadMeals();
                        updateProgressBars();
                        showToast('Meal deleted');
                    } catch (e) {
                        debug(`Error deleting meal: ${e.message}`);
                        showToast('Error deleting meal');
                    }
                }
            }
        }
        
        // Clear all meals
        function clearMeals() {
            if (confirm('Are you sure you want to delete ALL saved meals? This cannot be undone.')) {
                debug("Clearing all meals");
                storage.remove('protein-meals');
                loadMeals();
                updateProgressBars();
                showToast('All meals cleared');
            }
        }
        
        // Update progress bars
        function updateProgressBars() {
            const dailyGoal = parseInt(document.getElementById('tracking-daily-goal').textContent) || 0;
            const weeklyGoal = parseInt(document.getElementById('tracking-weekly-goal').textContent) || 0;
            
            if (dailyGoal === 0) {
                debug("No goals set, skipping progress update");
                return; // No goals set
            }
            
            // Get saved meals
            const savedMeals = storage.get('protein-meals');
            if (!savedMeals) {
                debug("No saved meals found for progress update");
                document.getElementById('consumed-today').textContent = '0';
                document.getElementById('consumed-week').textContent = '0';
                document.getElementById('daily-progress').style.width = '0%';
                document.getElementById('daily-progress').textContent = '0%';
                document.getElementById('weekly-progress').style.width = '0%';
                document.getElementById('weekly-progress').textContent = '0%';
                return;
            }
            
            let meals = [];
            try {
                meals = JSON.parse(savedMeals);
                debug(`Loaded ${meals.length} meals for progress update`);
            } catch (e) {
                debug(`Error parsing saved meals in updateProgressBars: ${e.message}`);
                return;
            }
            
            if (meals.length === 0) {
                debug("Meals array is empty in progress update");
                document.getElementById('consumed-today').textContent = '0';
                document.getElementById('consumed-week').textContent = '0';
                document.getElementById('daily-progress').style.width = '0%';
                document.getElementById('daily-progress').textContent = '0%';
                document.getElementById('weekly-progress').style.width = '0%';
                document.getElementById('weekly-progress').textContent = '0%';
                return;
            }
            
            // Get today's date in YYYY-MM-DD format
            const todayStr = getCurrentDate();
            debug(`Today's date (for progress comparison): ${todayStr}`);
            
            // Get start of week (Sunday) in YYYY-MM-DD format
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay()); // Go back to Sunday
            const startOfWeekStr = startOfWeek.toISOString().split('T')[0];
            
            debug(`Start of week: ${startOfWeekStr}`);
            
            // Calculate totals
            let todayTotal = 0;
            let weekTotal = 0;
            
            meals.forEach(meal => {
                debug(`Checking meal date: ${meal.date}, protein: ${meal.protein}`);
                
                // Compare the exact string formats to ensure proper matching
                if (meal.date === todayStr) {
                    debug(`Match for today: adding ${meal.protein}g protein`);
                    todayTotal += parseFloat(meal.protein || 0);
                }
                
                if (meal.date >= startOfWeekStr) {
                    debug(`Match for this week: adding ${meal.protein}g protein`);
                    weekTotal += parseFloat(meal.protein || 0);
                }
            });
            
            debug(`Calculated totals - Today: ${todayTotal}g, Week: ${weekTotal}g`);
            
            // Update display with visual feedback
            const consumedTodayElement = document.getElementById('consumed-today');
            const consumedWeekElement = document.getElementById('consumed-week');
            
            consumedTodayElement.textContent = todayTotal.toFixed(1);
            consumedWeekElement.textContent = weekTotal.toFixed(1);
            
            // Calculate percentages
            const dailyPercentage = Math.min(Math.round((todayTotal / dailyGoal) * 100), 100);
            const weeklyPercentage = Math.min(Math.round((weekTotal / weeklyGoal) * 100), 100);
            
            debug(`Progress percentages - Daily: ${dailyPercentage}%, Weekly: ${weeklyPercentage}%`);
            
            // Update progress bars
            const dailyProgressBar = document.getElementById('daily-progress');
            const weeklyProgressBar = document.getElementById('weekly-progress');
            
            dailyProgressBar.style.width = `${dailyPercentage}%`;
            dailyProgressBar.textContent = `${dailyPercentage}%`;
            weeklyProgressBar.style.width = `${weeklyPercentage}%`;
            weeklyProgressBar.textContent = `${weeklyPercentage}%`;
            
            // Add color classes
            dailyProgressBar.className = 'progress-bar';
            weeklyProgressBar.className = 'progress-bar';
            
            if (dailyPercentage < 40) {
                dailyProgressBar.classList.add('danger');
            } else if (dailyPercentage < 70) {
                dailyProgressBar.classList.add('warning');
            }
            
            if (weeklyPercentage < 40) {
                weeklyProgressBar.classList.add('danger');
            } else if (weeklyPercentage < 70) {
                weeklyProgressBar.classList.add('warning');
            }
        }
        
        // Analyze a meal description and estimate protein content
        function analyzeProtein() {
            const description = document.getElementById('meal-description').value.trim();
            
            if (!description) {
                showToast('Please enter a meal description');
                debug("Empty meal description");
                return;
            }
            
            debug(`Analyzing meal: "${description}"`);
            
            // Reset any previous analysis
            currentMealItems = [];
            currentMealProtein = 0;
            
            // Split input by commas first - BEFORE normalizing text
            const inputChunks = description.split(',').map(chunk => chunk.trim());
            debug(`Split into ${inputChunks.length} chunks`);
            
            // Debug info container
            const debugInfo = document.createElement('div');
            debugInfo.style.display = 'none';
            debugInfo.id = 'debug-info';
            document.body.appendChild(debugInfo);
            
            const results = [];
            let totalProtein = 0;
            
            // First check for complete meals (like "lentil soup" or "1 bowl of lentil soup")
            const completeMealRegex = /(\d*\.?\d*)\s*(bowls?|cups?|servings?)?(?:\s+of)?\s+([a-zA-Z\s]+)/i;
            
            for (let i = 0; i < inputChunks.length; i++) {
                const originalChunk = inputChunks[i];
                if (!originalChunk) continue;
                
                // Normalize chunk text
                const chunk = originalChunk.toLowerCase()
                    .replace(/[.;:!?()]/g, ' ')
                    .replace(/\s+/g, ' ')
                    .trim();
                
                debug(`Analyzing chunk: "${chunk}"`);
                
                // Debug info for this chunk
                const chunkInfo = document.createElement('p');
                chunkInfo.textContent = `Analyzing: "${chunk}"`;
                debugInfo.appendChild(chunkInfo);
                
                // Look for complete meals first (like "lentil soup" or "bowl of lentil soup")
                let completeMealMatch = null;
                let completeMealFood = null;
                
                // Check for complete prepared foods
                for (const food of veganFoods) {
                    if (food.servingSize) { // This indicates it's a prepared food
                        const foodName = food.name.toLowerCase();
                        
                        // Check if the chunk contains this prepared food
                        if (chunk.includes(foodName)) {
                            // We found a prepared food match! Now figure out quantity
                            let quantity = 1; // Default to 1 serving
                            
                            // Try to extract quantity
                            const match = chunk.match(completeMealRegex);
                            if (match && match[3].includes(foodName)) {
                                if (match[1] && !isNaN(parseFloat(match[1]))) {
                                    quantity = parseFloat(match[1]);
                                } else if (chunk.includes('half')) {
                                    quantity = 0.5;
                                } else if (chunk.includes('quarter')) {
                                    quantity = 0.25;
                                } else if (chunk.includes('two')) {
                                    quantity = 2;
                                } else if (chunk.includes('three')) {
                                    quantity = 3;
                                }
                            }
                            
                            const proteinAmount = food.protein * quantity;
                            
                            results.push({
                                food: food.name,
                                serving: `${quantity} ${food.servingSize.split(" ")[1] || 'serving'}`,
                                protein: proteinAmount,
                                originalText: originalChunk
                            });
                            
                            totalProtein += proteinAmount;
                            chunkInfo.textContent += ` - Found prepared food: ${food.name}, ${quantity} serving(s) = ${proteinAmount}g protein`;
                            debug(`Found prepared food: ${food.name}, ${quantity} serving(s) = ${proteinAmount}g protein`);
                            
                            // Mark this chunk as processed
                            completeMealMatch = true;
                            break;
                        }
                    }
                }
                
                // If we already found a match, skip the detailed analysis
                if (completeMealMatch) continue;
                
                // If not a complete meal, proceed with detailed ingredients analysis
                // Try to find a quantity
                let quantity = 1;
                let quantityFound = false;
                
                // First, look for "half", "quarter", etc.
                if (chunk.includes('half')) {
                    quantity = 0.5;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "half": quantity = ${quantity}`;
                    debug(`Found "half": quantity = ${quantity}`);
                } else if (chunk.includes('quarter')) {
                    quantity = 0.25;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "quarter": quantity = ${quantity}`;
                    debug(`Found "quarter": quantity = ${quantity}`);
                } else if (chunk.includes('third')) {
                    quantity = 0.33;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "third": quantity = ${quantity}`;
                    debug(`Found "third": quantity = ${quantity}`);
                } else if (chunk.includes('eighth')) {
                    quantity = 0.125;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "eighth": quantity = ${quantity}`;
                    debug(`Found "eighth": quantity = ${quantity}`);
                } 
                // Look for word numbers: "one", "two", etc.
                else if (/\bone\b/.test(chunk)) {
                    quantity = 1;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "one": quantity = ${quantity}`;
                    debug(`Found "one": quantity = ${quantity}`);
                } else if (/\btwo\b/.test(chunk)) {
                    quantity = 2;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "two": quantity = ${quantity}`;
                    debug(`Found "two": quantity = ${quantity}`);
                } else if (/\bthree\b/.test(chunk)) {
                    quantity = 3;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "three": quantity = ${quantity}`;
                    debug(`Found "three": quantity = ${quantity}`);
                } else if (/\bfour\b/.test(chunk)) {
                    quantity = 4;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "four": quantity = ${quantity}`;
                    debug(`Found "four": quantity = ${quantity}`);
                } else if (/\bfive\b/.test(chunk)) {
                    quantity = 5;
                    quantityFound = true;
                    chunkInfo.textContent += ` - Found "five": quantity = ${quantity}`;
                    debug(`Found "five": quantity = ${quantity}`);
                }
                
                // Only check for fractions if we haven't found a quantity yet
                if (!quantityFound) {
                    // Check for fractions like 1/2, 1/4, 1/3, etc.
                    const fractionRegex = /(\d+)\s*\/\s*(\d+)/;
                    const fractionMatch = chunk.match(fractionRegex);
                    
                    if (fractionMatch) {
                        const numerator = parseInt(fractionMatch[1]);
                        const denominator = parseInt(fractionMatch[2]);
                        if (denominator !== 0) {
                            quantity = numerator / denominator;
                            quantityFound = true;
                            chunkInfo.textContent += ` - Found fraction ${numerator}/${denominator}: quantity = ${quantity}`;
                            debug(`Found fraction ${numerator}/${denominator}: quantity = ${quantity}`);
                        }
                    } 
                    // Check for numeric values (this should be the last check)
                    else {
                        const numberRegex = /\b(\d+(\.\d+)?)\b/;
                        const numberMatch = chunk.match(numberRegex);
                        if (numberMatch) {
                            quantity = parseFloat(numberMatch[1]);
                            quantityFound = true;
                            chunkInfo.textContent += ` - Found number: quantity = ${quantity}`;
                            debug(`Found number: quantity = ${quantity}`);
                        }
                    }
                }
                
                // Try to find a measurement unit
                let measureGrams = 0;
                let measurementTerm = '';
                
                for (const measure of measurementReferences) {
                    for (const term of measure.terms) {
                        if (chunk.includes(term)) {
                            measureGrams = measure.grams;
                            measurementTerm = term;
                            chunkInfo.textContent += ` - Found measurement: "${term}" = ${measureGrams}g`;
                            debug(`Found measurement: "${term}" = ${measureGrams}g`);
                            break;
                        }
                    }
                    if (measureGrams > 0) break;
                }
                
                // If no measurement found, assume 100g
                if (measureGrams === 0) {
                    measureGrams = 100;
                    chunkInfo.textContent += ` - No measurement found, assuming 100g`;
                    debug(`No measurement found, assuming 100g`);
                }
                
                // Try to find a food item - search for best match
                let bestMatch = null;
                let bestMatchScore = 0;
                
                // First check for exact matches or close matches with food names
                for (const food of veganFoods) {
                    // Skip prepared foods here, we already checked them
                    if (food.servingSize) continue;
                    
                    // Check for the main food name
                    const foodName = food.name.toLowerCase();
                    
                    // Look for exact match
                    if (chunk.includes(foodName)) {
                        const score = foodName.length / chunk.length;
                        if (score > bestMatchScore) {
                            bestMatchScore = score;
                            bestMatch = food;
                            chunkInfo.textContent += ` - Found food: "${food.name}" (score: ${score.toFixed(2)})`;
                            debug(`Found food: "${food.name}" (score: ${score.toFixed(2)})`);
                        }
                    }
                    
                    // Check synonyms
                    if (food.synonyms) {
                        for (const synonym of food.synonyms) {
                            if (chunk.includes(synonym)) {
                                const score = synonym.length / chunk.length;
                                if (score > bestMatchScore) {
                                    bestMatchScore = score;
                                    bestMatch = food;
                                    chunkInfo.textContent += ` - Found food synonym: "${synonym}" → "${food.name}" (score: ${score.toFixed(2)})`;
                                    debug(`Found food synonym: "${synonym}" → "${food.name}" (score: ${score.toFixed(2)})`);
                                }
                            }
                        }
                    }
                }
                
                // If we found a food item
                if (bestMatch) {
                    // Calculate total grams
                    const grams = quantity * measureGrams;
                    
                    // Calculate protein in this item
                    const proteinAmount = (bestMatch.protein * grams / 100).toFixed(1);
                    
                    // Create serving description
                    let servingDesc = `${quantity} ${measurementTerm || `× ${measureGrams}g`}`;
                    
                    // Add to results
                    results.push({
                        food: bestMatch.name,
                        serving: servingDesc,
                        protein: parseFloat(proteinAmount),
                        originalText: originalChunk
                    });
                    
                    totalProtein += parseFloat(proteinAmount);
                    chunkInfo.textContent += ` - Added ${bestMatch.name}: ${proteinAmount}g protein`;
                    debug(`Added ${bestMatch.name}: ${proteinAmount}g protein`);
                } else {
                    chunkInfo.textContent += ` - No food match found`;
                    debug(`No food match found for "${chunk}"`);
                }
            }
            
            // Update globals with results
            currentMealItems = results;
            currentMealProtein = totalProtein;
            
            // Display results
            updateAnalysisDisplay();
            
            if (results.length === 0) {
                showToast('No ingredients recognized. Try being more specific or use manual entry.');
                debug("No ingredients recognized in analysis");
                return;
            }
            
            debug(`Analysis complete: Found ${results.length} ingredients with total ${totalProtein.toFixed(1)}g protein`);
            
            // Add a debug toggle button
            const analyzedItems = document.getElementById('analyzed-items');
            const debugButton = document.createElement('button');
            debugButton.textContent = 'Toggle Debug Info';
            debugButton.onclick = function() {
                const debugInfo = document.getElementById('debug-info');
                if (debugInfo) {
                    debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                }
            };
            debugButton.style.backgroundColor = '#999';
            analyzedItems.appendChild(debugButton);
            
            // If "Just Eaten" is checked, update progress immediately
            if (document.getElementById('just-eaten').checked) {
                debug("Just eaten is checked, updating progress");
                const mealName = document.getElementById('meal-name').value.trim() || 'Analyzed Meal';
                const mealDate = getCurrentDate(); // Always use today's date for "just eaten"
                
                // Create a temporary meal object for progress tracking
                const tempMeal = {
                    protein: totalProtein,
                    date: mealDate
                };
                
                // Update progress bars with this meal
                updateProgressWithMeal(tempMeal);
                
                showToast(`Added ${totalProtein.toFixed(1)}g protein to today's total`);
            } else {
                showToast('Meal analyzed successfully!');
            }
        }
    </script>
</body>
</html>
